<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
                "http://www.w3.org/TR/REC-html40/loose.dtd">
<html>
<head>
  <title>Description of cellprops3</title>
  <meta name="keywords" content="cellprops3">
  <meta name="description" content="cellprops3 Calculates the shape properties of the region or 'cell'">
  <meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1">
  <meta name="generator" content="m2html v1.5 &copy; 2003-2005 Guillaume Flandin">
  <meta name="robots" content="index, follow">
  <link type="text/css" rel="stylesheet" href="../../m2html.css">
</head>
<body>
<a name="_top"></a>
<div><a href="../../index.html">Home</a> &gt;  <a href="#">SuperSeggerRelease</a> &gt; <a href="index.html">segmentation</a> &gt; cellprops3.m</div>

<!--<table width="100%"><tr><td align="left"><a href="../../index.html"><img alt="<" border="0" src="../../left.png">&nbsp;Master index</a></td>
<td align="right"><a href="index.html">Index for SuperSeggerRelease/segmentation&nbsp;<img alt=">" border="0" src="../../right.png"></a></td></tr></table>-->

<h1>cellprops3
</h1>

<h2><a name="_name"></a>PURPOSE <a href="#_top"><img alt="^" border="0" src="../../up.png"></a></h2>
<div class="box"><strong>cellprops3 Calculates the shape properties of the region or 'cell'</strong></div>

<h2><a name="_synopsis"></a>SYNOPSIS <a href="#_top"><img alt="^" border="0" src="../../up.png"></a></h2>
<div class="box"><strong>function info = cellprops3( mask, props ) </strong></div>

<h2><a name="_description"></a>DESCRIPTION <a href="#_top"><img alt="^" border="0" src="../../up.png"></a></h2>
<div class="fragment"><pre class="comment"> cellprops3 Calculates the shape properties of the region or 'cell'

 INPUT :
       mask : cell / region mask
       props : proper generated by regionprops
 OUTPUT :
         info = [L1
             L2mean,
             Lneck,
             L2max,
             L2v,
             s1,
             s2,
             s3,
             RoundIndOver,
             RoundIndUnder,
             props.Area,
             stm1,
             sa1,
             sa2,
             sa3,
             sa4,
             1/L1,
             1/L2mean,
             minWidthEnd,
             sqmin,
             sqmax];

 Copyright (C) 2016 Wiggins Lab
 University of Washington, 2016
 This file is part of SuperSeggerOpti.</pre></div>

<!-- crossreference -->
<h2><a name="_cross"></a>CROSS-REFERENCE INFORMATION <a href="#_top"><img alt="^" border="0" src="../../up.png"></a></h2>
This function calls:
<ul style="list-style-image:url(../../matlabicon.gif)">
</ul>
This function is called by:
<ul style="list-style-image:url(../../matlabicon.gif)">
</ul>
<!-- crossreference -->

<h2><a name="_subfunctions"></a>SUBFUNCTIONS <a href="#_top"><img alt="^" border="0" src="../../up.png"></a></h2>
<ul style="list-style-image:url(../../matlabicon.gif)">
<li><a href="#_sub1" class="code">function tmp = norm2( dd )</a></li></ul>

<h2><a name="_source"></a>SOURCE CODE <a href="#_top"><img alt="^" border="0" src="../../up.png"></a></h2>
<div class="fragment"><pre>0001 <a name="_sub0" href="#_subfunctions" class="code">function info = cellprops3( mask, props )</a>
0002 <span class="comment">% cellprops3 Calculates the shape properties of the region or 'cell'</span>
0003 <span class="comment">%</span>
0004 <span class="comment">% INPUT :</span>
0005 <span class="comment">%       mask : cell / region mask</span>
0006 <span class="comment">%       props : proper generated by regionprops</span>
0007 <span class="comment">% OUTPUT :</span>
0008 <span class="comment">%         info = [L1</span>
0009 <span class="comment">%             L2mean,</span>
0010 <span class="comment">%             Lneck,</span>
0011 <span class="comment">%             L2max,</span>
0012 <span class="comment">%             L2v,</span>
0013 <span class="comment">%             s1,</span>
0014 <span class="comment">%             s2,</span>
0015 <span class="comment">%             s3,</span>
0016 <span class="comment">%             RoundIndOver,</span>
0017 <span class="comment">%             RoundIndUnder,</span>
0018 <span class="comment">%             props.Area,</span>
0019 <span class="comment">%             stm1,</span>
0020 <span class="comment">%             sa1,</span>
0021 <span class="comment">%             sa2,</span>
0022 <span class="comment">%             sa3,</span>
0023 <span class="comment">%             sa4,</span>
0024 <span class="comment">%             1/L1,</span>
0025 <span class="comment">%             1/L2mean,</span>
0026 <span class="comment">%             minWidthEnd,</span>
0027 <span class="comment">%             sqmin,</span>
0028 <span class="comment">%             sqmax];</span>
0029 <span class="comment">%</span>
0030 <span class="comment">% Copyright (C) 2016 Wiggins Lab</span>
0031 <span class="comment">% University of Washington, 2016</span>
0032 <span class="comment">% This file is part of SuperSeggerOpti.</span>
0033 
0034 debug = false;
0035 
0036 
0037 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0038 <span class="comment">%</span>
0039 <span class="comment">% Calculate cell thickness and length by rotating the</span>
0040 <span class="comment">% region based on the angle of the majorAxis.</span>
0041 <span class="comment">%</span>
0042 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0043 Orientation = props.Orientation;
0044 
0045 imRot = (fast_rotate_loose_double( mask, -Orientation+90 ));
0046 ss = size(imRot);
0047 
0048 
0049 <span class="keyword">if</span> debug
0050     figure(2);
0051     clf;
0052     imshow(cat(3,ag(imRot)+0.5*ag(~imRot),ag(imRot),ag(imRot)),<span class="string">'InitialMagnification'</span>,<span class="string">'fit'</span>);
0053     hold on;
0054 <span class="keyword">end</span>
0055 
0056 width       = sum(double(imRot),2);
0057 ymask       = (width&gt;=1);
0058 widthWindow = ([0;width(1:end-1)] + width + [width(2:end);0] )/3;
0059 
0060 L1          = sum(ymask);
0061 L2max       = max(widthWindow);
0062 L2v         = var(widthWindow);
0063 
0064 ymin = find(ymask,1,<span class="string">'first'</span>);
0065 ymax = find(ymask,1,<span class="string">'last'</span>);
0066 
0067 
0068 ind = (ymin):(ymax);
0069 L2mean = mean(width(ind));
0070 <span class="keyword">if</span> L2mean&lt;1
0071     L2mean=1;
0072 <span class="keyword">end</span>
0073 
0074 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0075 <span class="comment">%</span>
0076 <span class="comment">% Sine Cosine Idea</span>
0077 <span class="comment">%</span>
0078 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0079 nn = (numel(ind)-1);
0080 s  = 2*pi*(0:nn)/nn;
0081 
0082 s1 = mean(width(ind)'.*sin(s/2));
0083 s2 = mean(width(ind)'.*sin(s));
0084 s3 = mean(width(ind)'.*sin(s/3));
0085 
0086 
0087 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0088 <span class="comment">%</span>
0089 <span class="comment">% Calculate the neck width</span>
0090 <span class="comment">%</span>
0091 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0092 <span class="keyword">if</span> numel(widthWindow) &gt; 6;
0093     ww       = widthWindow';
0094     v        = ww(3:end)-ww(1:end-2);
0095     s_change = logical([0, sign(v(2:end))-sign(v(1:end-1)),0,0]);
0096     s_change(2:end) = logical(s_change(2:end)+s_change(1:end-1));
0097     
0098     ind = find(s_change);
0099     ind_ = ind(logical((ind&gt;3).*(ind&lt;(numel(ww)-2))));
0100     
0101     
0102     <span class="keyword">if</span> isempty(ind_)
0103         Lneck = L2mean;
0104         pos = mean([ymin,ymax]);
0105     <span class="keyword">else</span>
0106         [Lneck,pos] = min( ww(ind_) );
0107         pos = ind_(pos);
0108     <span class="keyword">end</span>
0109 <span class="keyword">else</span>
0110            Lneck = L2mean;
0111         pos = mean([ymin,ymax]);
0112 <span class="keyword">end</span>
0113 
0114 <span class="keyword">if</span> Lneck &gt; L2mean
0115     Lneck = L2mean;
0116     pos = mean([ymin,ymax]);
0117 <span class="keyword">end</span>
0118 
0119 <span class="keyword">if</span> debug
0120     xx = 1:numel(ww);
0121     
0122     figure(1);
0123     clf;
0124     plot( xx, ww, <span class="string">'.-'</span> );
0125     hold on;
0126     plot( pos+0*x,x, <span class="string">'r:'</span> );
0127         plot( xx(ind_), ww(ind_), <span class="string">'g.'</span> );
0128     figure(2)
0129 <span class="keyword">end</span>
0130 
0131 
0132 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0133 <span class="comment">%</span>
0134 <span class="comment">% thin ends</span>
0135 <span class="comment">%</span>
0136 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0137 im = find( logical(width), 1, <span class="string">'first'</span> );
0138 ip = find( logical(width), 1, <span class="string">'last'</span> );
0139 
0140 <span class="keyword">if</span> ip-im &gt;= 3
0141    m1 = mean( width(im+[ 0, 1]) );
0142    m4 = mean( width(ip+[-1, 0]) );
0143    minWidthEnd = min(m1,m4);
0144 <span class="keyword">else</span>
0145    minWidthEnd = L2mean;
0146 <span class="keyword">end</span>
0147 
0148 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0149 <span class="comment">%</span>
0150 <span class="comment">% Square ends</span>
0151 <span class="comment">%</span>
0152 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0153 <span class="keyword">if</span> ip-im &gt;= 7
0154     m2 = mean( width(im+[ 2, 3]) );
0155     m3 = mean( width(ip+[-3,-2]) );
0156 
0157     sq1 = m2-m1;
0158     sq2 = m3-m4;
0159     
0160     sqmax = max(sq1,sq2);
0161     sqmin = min(sq1,sq2);
0162 <span class="keyword">else</span>
0163    sqmax = 0;
0164    sqmin = 0;
0165 <span class="keyword">end</span>
0166 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0167 <span class="comment">%</span>
0168 <span class="comment">% Calculate the maximum bend angle.</span>
0169 <span class="comment">%</span>
0170 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0171 dr  = 3;
0172 dr2 = 3;
0173 yy = (ymin+dr):dr2:(ymax-dr);
0174 
0175 <span class="keyword">if</span> numel(yy) &gt; 4
0176     tmp = imRot(yy,:);
0177     
0178     x = 1:ss(2);
0179 
0180     
0181     [X,Y] = meshgrid(x,yy);
0182     
0183     xx = sum( X.*tmp,2 )./sum(tmp,2);
0184     
0185     d1 = [xx(1:end-2)-xx(3:end),yy(1:end-2)'-yy(3:end)'];
0186     
0187     dangle = ((d1(1:end-2,1).*d1(3:<span class="keyword">end</span>,2)<span class="keyword">...</span>
0188         -d1(1:end-2,2).*d1(3:<span class="keyword">end</span>,1))./<span class="keyword">...</span>
0189         (<a href="#_sub1" class="code" title="subfunction tmp = norm2( dd )">norm2</a>(d1(1:end-2,:)).*<a href="#_sub1" class="code" title="subfunction tmp = norm2( dd )">norm2</a>(d1(3:<span class="keyword">end</span>,:))));
0190     
0191         
0192     stm1 = max( dangle.^2 );
0193     
0194     
0195     angle = cumsum(dangle)';
0196     na = numel(angle)-1;
0197     
0198     s = (0:na)/na*pi/2;
0199 
0200     <span class="keyword">try</span>
0201     sa1 = mean( angle.*sin(s  ) );
0202     sa2 = mean( angle.*sin(s*2) );
0203     sa3 = mean( angle.*sin(s*3) );
0204     sa4 = mean( angle.*sin(s*4) );
0205     <span class="keyword">catch</span>
0206         <span class="string">'hi'</span>
0207     <span class="keyword">end</span>
0208     
0209     
0210     
0211         
0212     <span class="keyword">if</span> debug
0213         
0214         ss_ = size(d1);
0215         
0216         <span class="keyword">for</span> ii = 1:ss_(1)
0217             
0218             plot( xx(ii)+[0,-d1(ii,1)], yy(ii)+[0,-d1(ii,2)], <span class="string">'c.'</span> );
0219         <span class="keyword">end</span>
0220     <span class="keyword">end</span>
0221     
0222     
0223     
0224     <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0225     <span class="comment">%</span>
0226     <span class="comment">% Calculate the end score</span>
0227     <span class="comment">%</span>
0228     <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0229     yy = [(ymin+dr),(ymax-dr)];
0230     xx = widthWindow(round(yy));
0231     r = ((xx)/2);
0232     r(r&lt;1)=1;
0233     
0234     yyd = [(ymin+r(1)+[-1,0,1]),(ymax-r(2)+[-1,0,1])];
0235     yy  = round(yyd);
0236     
0237     [X] = meshgrid(x,yy);
0238     
0239     tmp = imRot(yy,:);
0240     xx = sum( X.*tmp,2 )./sum(tmp,2);
0241     xx = [mean(xx(1:3)),mean(xx(4:6))];
0242     yyd = yyd([2,5]);
0243 
0244     
0245     <span class="keyword">if</span> debug
0246         phi = 0:.1:2*pi;
0247         
0248         plot(xx,yyd,<span class="string">'go'</span>);
0249         xxx = r(1)*cos(phi);
0250         yyy = r(1)*sin(phi);
0251         plot(xx(1)+xxx,yy(1)+yyy,<span class="string">'g:'</span>)
0252         
0253         xxx = r(2)*cos(phi);
0254         yyy = r(2)*sin(phi);
0255         plot(xx(2)+xxx,yyd(2)+yyy,<span class="string">'g:'</span>)
0256         
0257         plot( [1,ss(2)],[ymax,ymax],<span class="string">':r'</span>)
0258         plot( [1,ss(2)],[ymin,ymin],<span class="string">':r'</span>)
0259         
0260     <span class="keyword">end</span>
0261     
0262     xcen = xx;
0263     ycen = yyd;
0264     
0265     x0 = xcen(1);
0266     y0 = ycen(1);
0267     r0 = r(1);
0268     
0269     yy = max(1,round(y0-r0-2)):min(round(y0+r0+2),ss(1));
0270     xx = max(1,round(x0-r0-2)):min(round(x0+r0+2),ss(2));
0271     
0272     [X,Y] = meshgrid(xx,yy);
0273     tmp = imRot(yy,xx);
0274     
0275     R2 = (X-x0).^2 + (Y-y0).^2 - r0^2;
0276     
0277     ind_over = find( ((R2 &gt; 0).*tmp).*(d1(1,1)*(X-x0) + d1(1,2)*(Y-y0) &gt; 0));
0278     ind_under = find( ((R2 &lt; 0).*(tmp&lt;1)).*(d1(1,1)*(X-x0) + d1(1,2)*(Y-y0) &gt; 0));
0279     
0280     
0281     <span class="keyword">if</span> debug
0282         plot(X(ind_over),Y(ind_over),<span class="string">'r.'</span>);
0283         plot(X(ind_under),Y(ind_under),<span class="string">'b.'</span>);
0284     <span class="keyword">end</span>
0285     
0286     RoundIndOverTop  = sum( tmp(ind_over).*R2(ind_over))/r0^4;
0287     RoundIndUnderTop = sum( (1-tmp(ind_under)).*abs(R2(ind_under)))/r0^4;
0288     
0289     x0 = xcen(2);
0290     y0 = ycen(2);
0291     r0 = r(2);
0292     
0293     yy = max(1,round(y0-r0-2)):min(round(y0+r0+2),ss(1));
0294     xx = max(1,round(x0-r0-2)):min(round(x0+r0+2),ss(2));
0295     
0296     [X,Y] = meshgrid(xx,yy);
0297     tmp = imRot(yy,xx);
0298     
0299     R2 = (X-x0).^2 + (Y-y0).^2 - r0^2;
0300     
0301     ind_over = find( ((R2 &gt; 0).*tmp).*(d1(1,1)*(X-x0) + d1(1,2)*(Y-y0) &lt; 0));
0302     ind_under = find( ((R2 &lt; 0).*(tmp&lt;1)).*(d1(1,1)*(X-x0) + d1(1,2)*(Y-y0) &lt; 0));
0303     
0304     <span class="keyword">if</span> debug
0305         plot(X(ind_over),Y(ind_over),<span class="string">'r.'</span>);
0306         plot(X(ind_under),Y(ind_under),<span class="string">'b.'</span>);
0307     <span class="keyword">end</span>
0308     
0309     
0310     RoundIndOverBot  = sum( tmp(ind_over).*R2(ind_over))/r0^4;
0311     RoundIndUnderBot = sum( (1-tmp(ind_under)).*abs(R2(ind_under)))/r0^4;
0312     
0313 <span class="keyword">else</span>
0314     <span class="comment">%'fail'</span>
0315     stm1 = 0;
0316     sa1 = 0;
0317     sa2 = 0;
0318     sa3 = 0;
0319     sa4 = 0;
0320     RoundIndOverTop  = 0;
0321     RoundIndUnderTop = 0;
0322     RoundIndOverBot  = 0;
0323     RoundIndUnderBot = 0;
0324     
0325 <span class="keyword">end</span>
0326 
0327 
0328 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0329 
0330 RoundIndOver  = RoundIndOverTop  + RoundIndOverBot;
0331 RoundIndUnder = RoundIndUnderTop + RoundIndUnderBot;
0332 
0333 
0334 
0335 
0336 <span class="keyword">if</span> L1 &lt; 1
0337     L1 = 1;
0338 <span class="keyword">end</span>
0339 
0340 
0341 <span class="comment">%info = [L1,L2,Lneck,curve];</span>
0342 info = [L1, <span class="keyword">...</span>
0343     L2mean, <span class="keyword">...</span>
0344     Lneck, <span class="keyword">...</span>
0345     L2max, <span class="keyword">...</span>
0346     L2v, <span class="keyword">...</span>
0347     s1, <span class="keyword">...</span>
0348     s2, <span class="keyword">...</span>
0349     s3, <span class="keyword">...</span>
0350     RoundIndOver, <span class="keyword">...</span>
0351     RoundIndUnder, <span class="keyword">...</span>
0352     props.Area, <span class="keyword">...</span><span class="comment">.</span>
0353     stm1, <span class="keyword">...</span>
0354     sa1, <span class="keyword">...</span>
0355     sa2, <span class="keyword">...</span>
0356     sa3, <span class="keyword">...</span>
0357     sa4, <span class="keyword">...</span>
0358     1/L1, <span class="keyword">...</span>
0359     1/L2mean,<span class="keyword">...</span>
0360     minWidthEnd,<span class="keyword">...</span>
0361     sqmin,<span class="keyword">...</span>
0362     sqmax];
0363 
0364 info(isnan(info)) = 0;
0365 
0366 <span class="keyword">if</span> numel(info) ~= 21
0367     <span class="string">'hi'</span>
0368 <span class="keyword">end</span>
0369 
0370 
0371 
0372 <span class="keyword">if</span> debug
0373     drawnow;
0374     keyboard;
0375 <span class="keyword">end</span>
0376 
0377 
0378 
0379 <span class="keyword">end</span>
0380 
0381 <a name="_sub1" href="#_subfunctions" class="code">function tmp = norm2( dd )</a>
0382 
0383 tmp = sqrt(sum(dd.*dd,2));
0384 
0385 <span class="keyword">end</span></pre></div>
<hr><address>Generated on Tue 23-Feb-2016 16:32:17 by <strong><a href="http://www.artefact.tk/software/matlab/m2html/" title="Matlab Documentation in HTML">m2html</a></strong> &copy; 2005</address>
</body>
</html>