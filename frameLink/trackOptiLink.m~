function trackOptiLink(dirname,disp_flag,frames,err_flag,CONST,header)
% trackOptiLink : computes the links (or overlaps) between subsequent frames
% and sets an error flag if the mapping isn't 1-to-1.
% After this runs, it creates either filename_trk.mat_ (first time)
% or filename_err.mat_ (after error resolution).
%
% INPUT :
%       dirname    : seg folder eg. maindirectory/xy1/seg
%       disp_flag  : a flag set for displaying the results
%       iii        : is the list of frames to relink.
%       err_flag   : is set when called after error resolution. 
%       CONST      : SuperSeggerOpti set parameters
%       header     : displayed string
%
% Copyright (C) 2016 Wiggins Lab
% University of Washington, 2016
% This file is part of SuperSeggerOpti.

if ~exist('disp_flag','var') || isempty( disp_flag );
    disp_flag = 0;
end

if ~exist('header','var')
    header = [];
end


if(nargin<1 || isempty(dirname))
    dirname=uigetdir()
end

dirname = fixDir(dirname);

if ~exist('err_flag','var') || isempty(err_flag)
    err_flag = 0;
end


if err_flag
    contents=dir([dirname '*_err.mat']);
else % first time through
    contents=dir([dirname '*_seg.mat']);
end

num_im = length(contents);

if ~exist('frames','var') || isempty(frames)
    frames = 1:num_im;
end


if CONST.show_status
    h = waitbar( 0, 'Linking Cells');
else
    h = [];
end

num_iii = numel(frames);

parfor(i = 1:num_iii, CONST.parallel_pool_num)
    intParFun( frames(i), num_im, dirname, contents, err_flag, CONST );
    if CONST.show_status
        waitbar(i/num_iii,h,['Linking Cells--Frame: ',num2str(frames(i)),'/',num2str(num_im)]);
    else
        disp( [header, 'Link: No status bar. Frame ',num2str(i), ...
            ' of ', num2str(num_im),'.']);
    end
end

if CONST.show_status
    close(h);
end

                                                                    
% write over old files
contents=dir([dirname '*.mat_']);
% if ispc
%     move_cmd = '!move ';
% else
%     move_cmd = '!mv ';
% end

num_ch = numel(contents);
% mov
for i = 1:num_ch
    tmp = [dirname,contents(i).name];
    movefile (tmp,tmp(1:end-1))
    %tot_move_cmd = [move_cmd,'"',tmp,'" "',tmp(1:end-1),'"'];
    %eval(tot_move_cmd);
end

end


function intParFun( i, num_im, dirname, contents, err_flag, CONST )
if (i ==1) && (1 == num_im) % one frame only
    data_r = [];
    data_c = prepData(loaderInternal([dirname,contents(i).name]));
    data_f = [];
elseif i == 1; % first frame, load current and forward
    data_r = [];
    data_c = prepData(loaderInternal([dirname,contents(i).name]));
    data_f = prepData(loaderInternal([dirname,contents(i+1).name]));
elseif (i == num_im) % last frame, loard current and reverse
    data_r = prepData(loaderInternal([dirname,contents(i-1).name]));
    data_c = prepData(loaderInternal([dirname,contents(i  ).name]));
    data_f = [];
else % all other frames, loadd currrent, reverse and forward
    data_r = prepData(loaderInternal([dirname,contents(i-1).name]));
    data_c = prepData(loaderInternal([dirname,contents(i  ).name]));
    data_f = prepData(loaderInternal([dirname,contents(i+1).name]));
end

% Calculate overlaps
data_c = trackOptiIntDiskNR( data_c, data_r, data_f, CONST );

if err_flag
    dataname=[dirname,contents(i).name(1:length(contents(i).name)-7),'err.mat_'];
else
    dataname=[dirname,contents(i).name(1:length(contents(i).name)-7),'trk.mat_'];
end

save(dataname,'-STRUCT','data_c');

% java garbage collection
heapTotalMemory = java.lang.Runtime.getRuntime.totalMemory;
heapFreeMemory = java.lang.Runtime.getRuntime.freeMemory;
if(heapFreeMemory < (heapTotalMemory*0.01))
    java.lang.Runtime.getRuntime.gc;
end

end


function data = prepData( data)
% prepData : extracts region information from data
% INPUT : initial data file
% OUTPUT : data file with regs info

data.regs.regs_label = bwlabel( data.mask_cell, 4 );
data.regs.props      = regionprops( data.regs.regs_label, {'Area', ...
    'Centroid', 'BoundingBox','Orientation', 'MajorAxisLength',...
    'MinorAxisLength'});
data.regs.num_regs   = max(data.regs.regs_label(:));

end


function data = loaderInternal( filename )
% loaderInternal : loads filename
data = load( filename );
end


